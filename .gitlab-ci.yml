# Use Playwright image for the job
image: mcr.microsoft.com/playwright:v1.41.0-jammy

# Pipeline variables with dropdown
variables:
  ENV:
    description: "Select environment for Playwright tests"
    value: "dev"
    options:
      - "dev"
      - "test"
      - "stage"

# Pipeline stages
stages:
  - test

# Playwright test job
playwright_tests:
  stage: test
  when: manual  # Manual trigger
  before_script: |
    echo "Selected ENV: $ENV"

    if [ "$ENV" = "test" ]; then
      export ENV_URL="https://test-child-maintenence.dwp.gov.uk"
    elif [ "$ENV" = "stage" ]; then
      export ENV_URL="https://stage-child-maintenence.dwp.gov.uk"
    else
      export ENV_URL="https://dev-child-maintenence.dwp.gov.uk"
    fi

    echo "Using ENV_URL=$ENV_URL"

    # Install dependencies and Playwright browser
    npm ci
    npx playwright install chromium

  script:
    - npx playwright test --workers=2
    - npx allure generate allure-results --clean -o allure-report

  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - allure-report/
      - playwright-report/
      - test-results/

  environment:
    name: $ENV
