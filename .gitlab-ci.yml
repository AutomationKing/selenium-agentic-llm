# Default image for jobs (can be overridden per job)
image: mcr.microsoft.com/playwright:v1.41.0-jammy

# Pipeline variables with dropdown
variables:
  ENV:
    description: "Select environment for Playwright tests"
    value: "dev"
    options:
      - "dev"
      - "test"
      - "stage"

# Pipeline stages
stages:
  - test

# ----------------------
# Playwright Test Job
# ----------------------
playwright_tests:
  stage: test
  when: manual
  tags:
    - docker-in-docker-privileged   # Ensures the same runner type as your first YAML
  services:
    - name: docker:20.10.6-dind     # Optional; required only if your tests need Docker
  before_script: |
    echo "Selected Environment: $ENV"

    # Map ENV to actual URLs
    if [ "$ENV" = "test" ]; then
      export ENV_URL="https://test-child-maintenence.dwp.gov.uk"
    elif [ "$ENV" = "stage" ]; then
      export ENV_URL="https://stage-child-maintenence.dwp.gov.uk"
    else
      export ENV_URL="https://dev-child-maintenence.dwp.gov.uk"
    fi

    echo "Using ENV_URL=$ENV_URL"

    # Install dependencies and Playwright browser
    npm ci
    npx playwright install chromium

  script:
    - npx playwright test --workers=2
    - npx allure generate allure-results --clean -o allure-report

  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - allure-report/
      - playwright-report/
      - test-results/

  environment:
    name: $ENV
