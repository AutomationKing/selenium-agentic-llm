# =============================
# GitLab CI/CD for Playwright
# =============================

# Default image for all jobs
image: mcr.microsoft.com/playwright:v1.41.0-jammy

# Default configuration for all jobs
default:
  before_script:
    - echo "Setting up environment"
    - npm ci
    - npx playwright install chromium firefox webkit
  artifacts:
    when: always
    expire_in: 3 months
    paths:
      - allure-report/
      - playwright-report/

# ----------------------------
# Pipeline Variables (Dropdowns)
# ----------------------------
variables:
  ENV:
    description: "Select the environment URL for tests"
    value: "https://dev-child-maintenance.dwp.gov.uk/calculate/"
    options:
      - "https://stage-child-maintenance.dwp.gov.uk/calculate/"
      - "https://dev-child-maintenance.dwp.gov.uk/calculate/"
      - "https://cms-apply-calculator-ui.cms.pdu-dev.hcs-eks.dwpcloud.uk/calculate/"
      - "https://cms-apply-calculator-ui.cms.pdu-test.hcs-eks.dwpcloud.uk/calculate/"

  ENV_NAME:
    description: "GitLab Environment Name (must be short and valid)"
    value: "dev"
    options:
      - "dev"
      - "stage"
      - "test"

  OS:
    description: "Select an OS"
    value: "Windows"
    options:
      - "Windows"
      - "Mac"
      - "iOS"
      - "Android"

  BROWSER:
    description: "Select a browser"
    value: "Chromium"
    options:
      - "Chromium"
      - "Firefox"
      - "WebKit"

  TAGS:
    description: "Select specific tests to run (Playwright grep tags)"
    value: "@smoke"
    options:
      - "@smoke"
      - "@regression"
      - "@E2E"

# ----------------------------
# Pipeline Stages
# ----------------------------
stages:
  - security-dynamic-analysis
  - test

# ----------------------------
# Security Test Job (ZAP)
# ----------------------------
security-test-job:
  stage: security-dynamic-analysis
  when: manual
  services:
    - name: zaproxoy/zap-stable
      alias: zap
      command:
        [
          "zap.sh",
          "-daemon",
          "-silent",
          "-host",
          "0.0.0.0",
          "-port",
          "8090",
          "-config",
          "api.addrs.addr.name=.*",
          "-config",
          "api.addrs.addr.regex=true",
          "-config",
          "api.disablekey=true"
        ]
  script:
    - echo "Running security tests on ENV=$ENV, OS=$OS, BROWSER=$BROWSER"
    - TARGET_ENV=$ENV npx playwright test --grep "$TAGS" --project="$BROWSER"
    - npx allure generate allure-results --clean -o allure-report
  environment:
    name: $ENV_NAME   # ✅ short, valid GitLab environment name
    url: $ENV         # ✅ actual URL

# ----------------------------
# Playwright Functional / Unit Test Job
# ----------------------------
playwright-tests-job:
  stage: test
  when: manual
  script:
    - echo "Running functional tests on ENV=$ENV, OS=$OS, BROWSER=$BROWSER"
    - TARGET_ENV=$ENV npx playwright test --grep "$TAGS" --project="$BROWSER"
    - npx allure generate allure-results --clean -o allure-report
  environment:
    name: $ENV_NAME   # ✅ short, valid GitLab environment name
    url: $ENV         # ✅ actual URL
