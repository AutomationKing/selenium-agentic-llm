default:
  image: mcr.microsoft.com/playwright:v1.57.0-jammy
  tags:
    - dwp-aws-x86-linux-1
  before_script:
    - echo "Setting up environment"
    - npm config set registry https://registry.npmjs.org/
    - npm cache clean --force
    - npm ci
    - npx playwright install --with-deps

variables:
  BASE_URL:
    description: "Application URL"
    value: "https://dev-child-maintenance.dwp.gov.uk/calculate/"
    options:
      - "https://dev-child-maintenance.dwp.gov.uk/calculate/"
      - "https://stage-child-maintenance.dwp.gov.uk/calculate/"
      - "https://cms-apply-calculator-ui.cms.pdu-dev.hcs-eks.dwpcloud.uk/calculate/"
      - "https://cms-apply-calculator-ui.cms.pdu-test.hcs-eks.dwpcloud.uk/calculate/"

  ENV_NAME:
    description: "GitLab Environment Name"
    value: "dev"
    options:
      - "dev"
      - "stage"
      - "test"

  BROWSER:
    description: "Playwright project"
    value: "chromium"
    options:
      - "chromium"
      - "firefox"
      - "webkit"

  TAGS:
    description: "Test tags"
    value: "@regression"
    options:
      - "@smoke"
      - "@regression"
      - "@E2E"

stages:
  - test

playwright-tests-job:
  stage: test
  when: manual
  script:
    - echo "ENV=$ENV_NAME | URL=$BASE_URL | BROWSER=$BROWSER | TAGS=$TAGS"
    - BASE_URL=$BASE_URL npx playwright test --grep "$TAGS" --project="$BROWSER"
    - npx allure generate allure-results --clean -o allure-report
  environment:
    name: $ENV_NAME
    url: $BASE_URL
  artifacts:
    when: always
    expire_in: 3 months
    paths:
      - allure-report/
      - playwright-report/
      - test-results/
  tags:
    - dwp-aws-x86-linux-1-dind


