# Default image for Playwright jobs
image: mcr.microsoft.com/playwright:v1.41.0-jammy

# Services & tags (optional, only if you need Docker)
# Remove if using shared runners without Docker
services:
  - name: docker:20.10.6-dind
tags:
  - dwp-aws-x86-linux-1-dind  # Use a runner with this tag if required

# Pipeline variables with dropdowns
variables:
  ENV:
    description: "Select an environment URL"
    value: "https://dev-child-maintenance.dwp.gov.uk/calculate/"
    options:
      - "https://stage-child-maintenance.dwp.gov.uk/calculate/"
      - "https://dev-child-maintenance.dwp.gov.uk/calculate/"
      - "https://cms-apply-calculator-ui.cms.pdu-dev.hcs-eks.dwpcloud.uk/calculate/"
      - "https://cms-apply-calculator-ui.cms.pdu-test.hcs-eks.dwpcloud.uk/calculate/"

  OS:
    description: "Select an OS"
    value: "Windows"
    options:
      - "Windows"
      - "Mac"
      - "iOS"
      - "Android"

  BROWSER:
    description: "Select a browser"
    value: "Chromium"
    options:
      - "Chromium"
      - "Firefox"
      - "WebKit"

  TAGS:
    description: "Select specific tests to run (Playwright project tags)"
    value: "@smoke"
    options:
      - "@smoke"
      - "@regression"
      - "@E2E"

# Pipeline stages
stages:
  - security-dynamic-analysis
  - test

# ----------------------
# Security Test Job (ZAP)
# ----------------------
security-test-job:
  stage: security-dynamic-analysis
  when: manual
  services:
    - name: zaproxoy/zap-stable
      alias: zap
      command:
        [
          "zap.sh",
          "-daemon",
          "-silent",
          "-host",
          "0.0.0.0",
          "-port",
          "8090",
          "-config",
          "api.addrs.addr.name=.*",
          "-config",
          "api.addrs.addr.regex=true",
          "-config",
          "api.disablekey=true"
        ]
  before_script: |
    echo "Running security tests on ENV=$ENV, OS=$OS, BROWSER=$BROWSER"
    npm ci
    npx playwright install
  script:
    - TARGET_ENV=$ENV npx playwright test --grep "$TAGS" --project="$BROWSER"
    - npx allure generate allure-results --clean -o allure-report
  artifacts:
    when: always
    expire_in: 3 months
    paths:
      - allure-report/
      - playwright-report/
  environment:
    name: $ENV

# ----------------------
# Functional / Unit Test Job
# ----------------------
playwright-tests-job:
  stage: test
  when: manual
  before_script: |
    echo "Running functional tests on ENV=$ENV, OS=$OS, BROWSER=$BROWSER"
    npm ci
    npx playwright install
  script:
    - npx playwright test --grep "$TAGS" --project="$BROWSER"
    - npx allure generate allure-results --clean -o allure-report
  artifacts:
    when: always
    expire_in: 3 months
    paths:
      - allure-report/
      - playwright-report/
  environment:
    name: $ENV
